pipeline {
    agent any
    
    environment {
        DB_PASSWORD = credentials('DB_PASSWORD')
    }
    
    stages {
        stage('checkout source code') {
            steps {
                git url: "https://github.com/LJDunford/lbg-duo-task.git", branch: "master"
            }
        }
        stage('Build') {
            steps {
                sh 'docker build -t duo-client:v2 .'
            }
        }
        stage('run containers') {
            steps {
                sh '''
                docker network inspect duo-net && sleep 1 || docker network create duo-net
                docker run -d -e MYSQL_ROOT_PASSWORD=${DB_PASSWORD} --name duo-db --network duo-net ldunford/duo-db:latest
                docker run -d -e DB_PASSWORD=${DB_PASSWORD} --name duo-service --network duo-net ldunford/duo-service:latest
                docker run -d -p 80:80 --network duo-net --name duo-client duo-client:v2
                '''
            }
        }
    }
}
