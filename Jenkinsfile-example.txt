pipeline {
    agent any
    
    environment {
        DB_PASSWORD = credentials('DB_PASSWORD')
    }
    
    stages {
        stage('checkout source code') {
            steps {
                git url: "https://github.com/LJDunford/lbg-duo-task.git", branch: "master"
            }
        }
        stage('cleanup') {
            steps {
                sh '''
                if docker logs duo-db; then
                    if docker exec duo-db ls; then
                        docker stop duo-db
                    fi
                    docker rm duo-db
                fi
                if docker logs duo-service; then
                    if docker exec duo-service ls; then
                        docker stop duo-service
                    fi
                    docker rm duo-service
                fi
                if docker logs duo-client; then
                    if docker exec duo-client ls; then
                        docker stop duo-client
                    fi
                    docker rm duo-client
                fi
                docker rmi duo-client:v1
                '''
            }
        }
        stage('Build') {
            steps {
                sh 'docker build -t duo-client:v2 .'
            }
        }
        stage('run containers') {
            steps {
                sh '''
                docker network inspect duo-net && sleep 1 || docker network create duo-net
                docker run -d -e MYSQL_ROOT_PASSWORD=${DB_PASSWORD} --name duo-db --network duo-net duo-db:latest
                docker run -d -e DB_PASSWORD=${DB_PASSWORD} --name duo-service --network duo-net duo-service:latest
                docker run -d -p 80:80 --network duo-net --name duo-client duo-client:v2
                '''
            }
        }
    }
}
